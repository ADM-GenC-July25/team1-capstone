<div [attr.data-theme]="isDarkMode() ? 'dark' : null">
    <div class="shipment-container">
        <div class="shipment-header">
            <h1 class="shipment-title">Shipment Tracking</h1>
            <p class="shipment-subtitle">Track and manage your shipments</p>
        </div>

        <div class="table-container">
            @if (isLoading()) {
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading your shipments...</p>
            </div>
            } @else if (error()) {
            <div class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Error Loading Shipments</h3>
                <p>{{ error() }}</p>
                <button class="btn btn-primary" (click)="loadShipments()">Try Again</button>
            </div>
            } @else {
            <div class="table-wrapper">
                <table class="shipments-table">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Delivery Address</th>
                            <th>Status</th>
                            <th>Total Price</th>
                            <th>Est. Delivery</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for(shipment of shipments(); track shipment.transactionId) {
                        <tr class="shipment-row" [class]="getStatusClass(shipment.status ?? '')">
                            <td class="shipment-id">
                                <span class="id-text">#{{ shipment.transactionId }}</span>
                            </td>
                            <td class="route">
                                <div class="route-container">
                                    <span class="destination">{{ shipment.deliveryAddress }}</span>
                                </div>
                            </td>
                            <td class="status">
                                <span class="status-badge" [class]="getStatusClass(shipment.status ?? '')">
                                    {{ shipment.status }}
                                </span>
                            </td>
                            <td class="price">
                                <div class="price-info">
                                    <span class="price-amount">${{ shipment.price | number:'1.2-2' }}</span>
                                </div>
                            </td>
                            <td class="delivery-date">
                                <div class="date-info">
                                    <span class="date">{{ shipment.estimatedDelivery | date:'MMM dd' }}</span>
                                    <span class="year">{{ shipment.estimatedDelivery | date:'yyyy' }}</span>
                                </div>
                            </td>
                            <td class="actions">
                                <div class="action-buttons">
                                    <button class="btn btn-secondary btn-sm"
                                        (click)="viewDetails(shipment.transactionId)" title="View Details">
                                        <span class="btn-icon">üëÅ</span>
                                    </button>
                                    <button class="btn btn-sm cancel-btn"
                                        [class.btn-cancel-active]="canCancelShipment(shipment)"
                                        [class.btn-cancel-disabled]="!canCancelShipment(shipment)"
                                        [disabled]="!canCancelShipment(shipment)"
                                        (click)="cancelShipment(shipment.transactionId)" title="Cancel Shipment">
                                        <span class="btn-icon">‚úï</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (shipments().length == 0 || shipments() == null) {
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <h3>No shipments found</h3>
                <p>You don't have any shipments to track yet.</p>
                <p class="empty-subtitle">Start shopping to see your orders and track their delivery!</p>
                <button class="btn btn-primary" (click)="navigateToShopping()">
                    Start Shopping
                </button>
            </div>
            }
            }
        </div>
    </div>

    <!-- Details Overlay -->
    @if (showDetailsOverlay() && selectedShipment()) {
    <div class="overlay-backdrop" (click)="closeDetailsOverlay()">
        <div class="details-overlay" (click)="$event.stopPropagation()">
            <div class="overlay-header">
                <h2 class="overlay-title">Shipment Details</h2>
                <button class="close-btn" (click)="closeDetailsOverlay()" title="Close">
                    <span class="close-icon">‚úï</span>
                </button>
            </div>

            <div class="overlay-content">
                <div class="detail-section">
                    <h3 class="section-title">Order Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Transaction ID:</label>
                            <span>#{{ selectedShipment()!.transactionId }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Status:</label>
                            <span class="status-badge" [class]="getStatusClass(selectedShipment()!.status ?? '')">
                                {{ selectedShipment()!.status }}
                            </span>
                        </div>
                        <div class="detail-item">
                            <label>Total Price:</label>
                            <span>${{ selectedShipment()!.price | number:'1.2-2' }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title">Delivery Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Delivery Address:</label>
                            <span>{{ selectedShipment()!.deliveryAddress }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Order Date:</label>
                            <span>{{ selectedShipment()!.transactionDate | date:'MMM dd, yyyy h:mm a' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Estimated Delivery:</label>
                            <span>{{ selectedShipment()!.estimatedDelivery | date:'MMM dd, yyyy' }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3 class="section-title">Items in this Shipment</h3>
                    <div class="items-list">
                        @if (isLoading()) {
                        <div class="loading-items">
                            <div class="loading-spinner"></div>
                            <p>Loading items...</p>
                        </div>
                        } @else if (selectedShipment()!.items) {
                        @for (item of selectedShipment()!.items; track item.productId) {
                        <div class="item-card">
                            <div class="item-info">
                                <h4 class="item-name">{{ item.productName || 'Product #' + item.productId }}</h4>
                                <div class="item-details">
                                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                                    <span class="item-price">${{ (item.priceAtPurchase || item.price) | number:'1.2-2'
                                        }} each</span>
                                    <span class="item-delivery">{{ item.daysToDeliver || 5 }} days delivery</span>
                                </div>
                            </div>
                            <div class="item-total">
                                ${{ (item.quantity * (item.priceAtPurchase || item.price)) | number:'1.2-2' }}
                            </div>
                        </div>
                        }
                        } @else {
                        <div class="empty-items">
                            <p>No items found for this shipment.</p>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <div class="overlay-actions">
                @if (canCancelShipment(selectedShipment()!)) {
                <button class="btn btn-cancel-active"
                    (click)="cancelShipment(selectedShipment()!.transactionId); closeDetailsOverlay()">
                    Cancel Shipment
                </button>
                }
                <button class="btn btn-secondary" (click)="closeDetailsOverlay()">
                    Close
                </button>
            </div>
        </div>
    </div>
    }
</div>