<div [attr.data-theme]="isDarkMode() ? 'dark' : null" class="app-container">
  <!-- Checkout Header Section -->
  <section class="hero">
    <div class="hero-content">
      <h1 class="hero-title">Checkout</h1>
      <p class="hero-subtitle">Complete your purchase securely</p>
    </div>
  </section>

  <!-- Step Indicator -->
  <section class="categories">
    <div class="container">
      <div class="step-indicator">
        <div class="step-card" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
          <div class="step-number">1</div>
          <h3>Payment</h3>
        </div>
        <div class="step-card" [class.active]="currentStep >= 3">
          <div class="step-number">2</div>
          <h3>Review</h3>
        </div>
      </div>
    </div>
  </section>

  <!-- Checkout Content -->
  <section class="featured-products">
    <div class="container">
      <div class="checkout-content">
        <div class="checkout-main">


          <!-- Step 1: Payment Information -->
          <div *ngIf="currentStep === 2" class="checkout-step">
            <h2 class="section-title">Payment Information</h2>
            <form [formGroup]="paymentForm" class="checkout-form">

              <!-- Loading indicator for payment methods -->
              <div *ngIf="isLoadingPaymentMethods" class="loading-message">
                Loading your saved payment methods...
              </div>
              
              <!-- Saved Payment Methods -->
              <div class="form-group" *ngIf="savedPaymentMethods.length > 0 && !isLoadingPaymentMethods">
                <label>Use Saved Payment Method</label>
                <select formControlName="savedPaymentMethodId" (change)="onSavedPaymentMethodChange()">
                  <option value="">Enter new payment method</option>
                  <option *ngFor="let payment of savedPaymentMethods" [value]="payment.id">
                    {{payment.name}} ({{payment.expiryMonth}}/{{payment.expiryYear}})
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label>Card Number *</label>
                <input type="text" formControlName="cardNumber" placeholder="1234 5678 9012 3456"
                  [class.error]="isFieldInvalid(paymentForm, 'cardNumber', paymentFormSubmitted)"
                  (focus)="onCardNumberFocus()" (blur)="onCardNumberBlur()" (input)="onCardNumberInput($event)"
                  required>
                <div *ngIf="isFieldInvalid(paymentForm, 'cardNumber', paymentFormSubmitted)" class="error-message">
                  {{getFieldError(paymentForm, 'cardNumber')}}
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Expiry Month *</label>
                  <select formControlName="expiryMonth"
                    [class.error]="isFieldInvalid(paymentForm, 'expiryMonth', paymentFormSubmitted)" required>
                    <option value="">Select Month</option>
                    <option *ngFor="let month of months" [value]="month.value">
                      {{month.label}}
                    </option>
                  </select>
                  <div *ngIf="isFieldInvalid(paymentForm, 'expiryMonth', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'expiryMonth')}}
                  </div>
                </div>
                <div class="form-group">
                  <label>Expiry Year *</label>
                  <select formControlName="expiryYear"
                    [class.error]="isFieldInvalid(paymentForm, 'expiryYear', paymentFormSubmitted)" required>
                    <option value="">Select Year</option>
                    <option *ngFor="let year of years" [value]="year.value">
                      {{year.label}}
                    </option>
                  </select>
                  <div *ngIf="isFieldInvalid(paymentForm, 'expiryYear', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'expiryYear')}}
                  </div>
                </div>
                <div class="form-group">
                  <label>CVV *</label>
                  <input type="text" formControlName="cvv" placeholder="123"
                    [class.error]="isFieldInvalid(paymentForm, 'cvv', paymentFormSubmitted)" (focus)="onCvvFocus()"
                    (blur)="onCvvBlur()" (input)="onCvvInput($event)" maxlength="4" required>
                  <div *ngIf="isFieldInvalid(paymentForm, 'cvv', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'cvv')}}
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Name on Card *</label>
                <input type="text" formControlName="cardName"
                  [class.error]="isFieldInvalid(paymentForm, 'cardName', paymentFormSubmitted)" required>
                <div *ngIf="isFieldInvalid(paymentForm, 'cardName', paymentFormSubmitted)" class="error-message">
                  {{getFieldError(paymentForm, 'cardName')}}
                </div>
              </div>

              <!-- Save Payment Method Toggle -->
              <div class="form-group">
                <button type="button" class="toggle-button" [class.active]="savePaymentMethod"
                  (click)="toggleSavePaymentMethod()">
                  <span class="checkbox">{{savePaymentMethod ? '✓' : ''}}</span>
                  Save payment method for future purchases
                </button>
              </div>

              <div class="billing-header">
                <h3 class="subsection-title">Billing Address</h3>
                <button type="button" class="toggle-button" [class.active]="sameAsShipping"
                  (click)="toggleSameAsShipping()">
                  <span class="checkbox">{{sameAsShipping ? '✓' : ''}}</span>
                  Same as shipping address
                </button>
              </div>

              <div class="form-group">
                <label>Address Line 1 *</label>
                <input type="text" formControlName="billingAddressLineOne" placeholder="123 Main Street"
                  [class.error]="isFieldInvalid(paymentForm, 'billingAddressLineOne', paymentFormSubmitted)"
                  [disabled]="sameAsShipping" required>
                <div *ngIf="isFieldInvalid(paymentForm, 'billingAddressLineOne', paymentFormSubmitted)" class="error-message">
                  {{getFieldError(paymentForm, 'billingAddressLineOne')}}
                </div>
              </div>

              <div class="form-group">
                <label>Address Line 2 (Optional)</label>
                <input type="text" formControlName="billingAddressLineTwo" placeholder="Apt 4B, Suite 100, Unit 5"
                  [disabled]="sameAsShipping">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>City *</label>
                  <input type="text" formControlName="billingCity"
                    [class.error]="isFieldInvalid(paymentForm, 'billingCity', paymentFormSubmitted)"
                    [disabled]="sameAsShipping" required>
                  <div *ngIf="isFieldInvalid(paymentForm, 'billingCity', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'billingCity')}}
                  </div>
                </div>
                <div class="form-group">
                  <label>State *</label>
                  <input type="text" formControlName="billingState"
                    [class.error]="isFieldInvalid(paymentForm, 'billingState', paymentFormSubmitted)"
                    [disabled]="sameAsShipping" required>
                  <div *ngIf="isFieldInvalid(paymentForm, 'billingState', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'billingState')}}
                  </div>
                </div>
                <div class="form-group">
                  <label>ZIP Code *</label>
                  <input type="text" formControlName="billingZip"
                    [class.error]="isFieldInvalid(paymentForm, 'billingZip', paymentFormSubmitted)"
                    [disabled]="sameAsShipping" required>
                  <div *ngIf="isFieldInvalid(paymentForm, 'billingZip', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'billingZip')}}
                  </div>
                </div>
                <div class="form-group">
                  <label>Country *</label>
                  <input type="text" formControlName="billingCountry" placeholder="United States"
                    [class.error]="isFieldInvalid(paymentForm, 'billingCountry', paymentFormSubmitted)"
                    [disabled]="sameAsShipping" required>
                  <div *ngIf="isFieldInvalid(paymentForm, 'billingCountry', paymentFormSubmitted)" class="error-message">
                    {{getFieldError(paymentForm, 'billingCountry')}}
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Step 2: Order Review -->
          <div *ngIf="currentStep === 3" class="checkout-step">
            <h2 class="section-title">Review Your Order</h2>
            <div class="order-review">
              <div class="review-section">
                <h3>Shipping Information</h3>
                <p>{{shippingForm.value.firstName}} {{shippingForm.value.lastName}}</p>
                <p>{{shippingForm.value.address}}</p>
                <p *ngIf="shippingForm.value.apartment">{{shippingForm.value.apartment}}</p>
                <p>{{shippingForm.value.city}}, {{shippingForm.value.state}} {{shippingForm.value.zipCode}}</p>
                <p><strong>Standard Shipping (5-7 days)</strong></p>
              </div>

              <div class="review-section">
                <h3>Payment Method</h3>
                <p>**** **** **** {{actualCardNumber?.slice(-4) || '****'}}</p>
                <p>{{paymentForm.value.cardName}}</p>
                <p>Expires: {{paymentForm.value.expiryMonth}}/{{paymentForm.value.expiryYear}}</p>
                <p *ngIf="savePaymentMethod" class="save-method-note">
                  <em>✓ Payment method will be saved for future purchases</em>
                </p>
              </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="checkout-navigation">
            <button *ngIf="currentStep > 2" (click)="previousStep()" class="cta-button secondary">
              Previous
            </button>
            <button *ngIf="currentStep < 3" (click)="nextStep()" class="cta-button">
              Next
            </button>
            <button *ngIf="currentStep === 3" (click)="placeOrder()" class="cta-button" type="button">
              Place Order
            </button>
          </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="order-summary">
          <div class="product-card">
            <h3>Order Summary</h3>

            <!-- Loading State -->
            <div *ngIf="isCartLoading" class="loading-state">
              <div class="loading-spinner"></div>
              <p>Loading your cart...</p>
            </div>

            <!-- Error State -->
            <div *ngIf="cartError" class="error-state">
              <div class="error-icon">⚠️</div>
              <p>{{ cartError }}</p>
              <button class="btn btn-primary" (click)="refreshCart()">Try Again</button>
            </div>

            <!-- Cart Items -->
            <div *ngIf="!isCartLoading && !cartError" class="cart-items">
              <div *ngFor="let item of cartItems" class="cart-item">
                <img [src]="item.image" [alt]="item.name" class="product-image">
                <div class="item-details">
                  <h4 class="product-name">{{item.name}}</h4>
                  <div class="quantity-controls">
                    <button class="quantity-btn" (click)="updateQuantity(item.id, item.quantity - 1)">-</button>
                    <span class="quantity">{{item.quantity}}</span>
                    <button class="quantity-btn" (click)="updateQuantity(item.id, item.quantity + 1)">+</button>
                  </div>
                  <p class="product-price">${{(item.price * item.quantity).toFixed(2)}}</p>
                  <button class="remove-btn" (click)="removeItem(item.id)">Remove</button>
                </div>
              </div>
            </div>

            <div class="summary-totals">
              <div class="summary-line">
                <span>Subtotal:</span>
                <span>${{orderSummary().subtotal.toFixed(2)}}</span>
              </div>
              <div class="summary-line">
                <span>Standard Shipping:</span>
                <span>${{orderSummary().shipping.toFixed(2)}}</span>
              </div>
              <div class="summary-line">
                <span>Tax:</span>
                <span>${{orderSummary().tax.toFixed(2)}}</span>
              </div>
              <div class="summary-line total">
                <span>Total:</span>
                <span class="product-price">${{orderSummary().total.toFixed(2)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>