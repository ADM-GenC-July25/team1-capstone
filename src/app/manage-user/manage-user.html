<div class="page-container" [style.background]="isDarkMode() ? 'hsla(220, 22%, 17%, 1)' : 'hsla(0, 0%, 97%, 1)'">
    <div [attr.data-theme]="isDarkMode() ? 'dark' : null" class="admin-container">
        <div class="admin-header">
            <h1>User Management</h1>
        </div>

        <!-- Create New User Form -->
        <div class="create-user-section">
            <h2>Create New User</h2>
            <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input id="email" type="email" formControlName="email" class="form-input">
                        @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
                            <div class="error-message">Please enter a valid email address</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <input id="username" type="text" formControlName="username" class="form-input">
                        @if (userForm.get('username')?.invalid && userForm.get('username')?.touched) {
                            <div class="error-message">Username is required</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input id="firstName" type="text" formControlName="firstName" class="form-input">
                        @if (userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched) {
                            <div class="error-message">First name is required</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input id="lastName" type="text" formControlName="lastName" class="form-input">
                        @if (userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched) {
                            <div class="error-message">Last name is required</div>
                        }
                    </div>
                    
                    <div class="form-group">
                        <label for="birthday">Date of Birth</label>
                        <input id="birthday" type="date" formControlName="birthday" class="form-input">
                        @if (userForm.get('birthday')?.invalid && userForm.get('birthday')?.touched) {
                            <div class="error-message">Date of birth is required</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input id="phone" type="tel" formControlName="phone" class="form-input">
                        @if (userForm.get('phone')?.invalid && userForm.get('phone')?.touched) {
                            <div class="error-message">Phone number is required</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <input id="password" type="password" formControlName="password" class="form-input">
                        @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
                            <div class="error-message">Password is required</div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" formControlName="role" class="form-select">
                            @for (role of availableRoles; track role) {
                                <option [value]="role">{{role | titlecase}}</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" [disabled]="!userForm.valid || isLoading()" class="btn btn-primary">
                        @if (isLoading()) {
                            <span class="loader"></span>
                        }
                        Create User
                    </button>
                </div>
            </form>
        </div>

        <!-- Success/Error Messages -->
        @if (successMessage()) {
            <div class="success-message">{{ successMessage() }}</div>
        }
        @if (errorMessage()) {
            <div class="error-message">{{ errorMessage() }}</div>
        }

        <!-- Users List -->
        <div class="users-list-section">
            <h2>Manage Users</h2>
            @if (isLoading()) {
                <div class="loading">Loading users...</div>
            } @else if (users().length === 0) {
                <div class="no-users">No users found</div>
            } @else {
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (user of users(); track user.id) {
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.firstName }} {{ user.lastName }}</td>
                                    <td>{{ user.roles[0] | titlecase }}</td>                                
                                    <td class="action-buttons">
                                        <button 
                                            class="btn btn-small btn-edit"
                                            (click)="editUser(user)">
                                            <span class="btn-icon">✎</span>
                                        </button>
                                        <button 
                                            class="btn btn-small btn-danger"
                                            (click)="deleteUser(user.id)">
                                            <span class="btn-icon">✕</span>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for editing user -->
<div class="modal" *ngIf="editingUser()" [class.show]="editingUser()">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit User</h2>
            <button class="close-button" (click)="cancelEdit()">&times;</button>
        </div>
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input id="email" type="email" formControlName="email" class="form-input">
                    <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                        Please enter a valid email address
                    </div>
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input id="username" type="text" formControlName="username" class="form-input">
                    <div class="error-message" *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
                        Username is required
                    </div>
                </div>

                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input id="firstName" type="text" formControlName="firstName" class="form-input">
                    <div class="error-message" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
                        First name is required
                    </div>
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input id="lastName" type="text" formControlName="lastName" class="form-input">
                    <div class="error-message" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                        Last name is required
                    </div>
                </div>

                <div class="form-group">
                        <label for="birthday">Date of Birth</label>
                        <input id="birthday" type="date" formControlName="birthday" class="form-input">
                        @if (userForm.get('birthday')?.invalid && userForm.get('birthday')?.touched) {
                            <div class="error-message">Date of birth is required</div>
                        }
                    </div>

                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input id="phone" type="tel" formControlName="phone" class="form-input">
                    <div class="error-message" *ngIf="userForm.get('phone')?.invalid && userForm.get('phone')?.touched">
                        Please enter a valid phone number
                    </div>
                </div>

                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" formControlName="role" class="form-input">
                        <option *ngFor="let role of availableRoles" [value]="role" [selected]="role">{{role | titlecase}}</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
                <button type="submit" class="btn btn-primary" [disabled]="!userForm.valid || isLoading()">
                    <span *ngIf="isLoading()" class="loader"></span>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal-backdrop" *ngIf="editingUser()" (click)="cancelEdit()"></div>